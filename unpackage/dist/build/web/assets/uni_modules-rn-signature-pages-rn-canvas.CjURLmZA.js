var t=Object.defineProperty,e=(e,s,i)=>(((e,s,i)=>{s in e?t(e,s,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[s]=i})(e,"symbol"!=typeof s?s+"":s,i),i);import{a3 as s,a4 as i,B as n,a5 as a,a6 as o,Z as c,s as h,V as l,c as r,w as d,i as u,o as p,b as x,q as w,t as y,F as m,a7 as v,a8 as g,v as f,n as _,d as b,x as C}from"./index-DszEigh-.js";import{_ as P}from"./_plugin-vue_export-helper.BCo6x5W8.js";class T{constructor(t,s){e(this,"drawCount",0),e(this,"ctx",null),e(this,"_this",null),e(this,"context",null),e(this,"dpr",1),e(this,"points",[]),e(this,"newPoint",{}),e(this,"lastSpeed",0),e(this,"lastWidth",8),e(this,"config",{windowWidth:null,windowHeight:null,art:{enable:!1},ctx:{lineWidth:8,lineCap:"round",lineJoin:"round"},placeholder:{content:"请设置个性签名",fontSize:40,textBaseline:"middle",textAlign:"center",fillStyle:"#888"}}),e(this,"options",{canvas_id:""}),this._this=s,this.options={...this.config,...t||{},art:{...this.config.art,...t.art||{}},ctx:{...this.config.ctx,...t.ctx||{}},placeholder:{...this.config.placeholder,...t.placeholder||{}}},this.initPage(),this.initCanvas()}touchstart(t){let e,s;0==this.drawCount&&this.ctx.draw(),this.initPen(),this.drawCount++,this.ctx.beginPath();let i=t.changedTouches[0];e=i.x||i.clientX,s=i.y||i.clientY,this.points=[{x:e,y:s,time:Date.now()}],this.ctx.moveTo(e,s)}touchmove(t){let e,s,i=t.changedTouches[0];e=i.x||i.clientX,s=i.y||i.clientY,this.options.art.enable?this.speedCalc({x:e,y:s}):this.ctx.lineTo(e,s),this.ctx.stroke(),this.ctx.draw(!0),this.ctx.moveTo(e,s)}speedCalc({x:t,y:e}){this.newPoint={x:t,y:e,time:Date.now()};const s=this.points[this.points.length-1],i=Math.hypot(this.newPoint.x-s.x,this.newPoint.y-s.y)/(this.newPoint.time-s.time);let n=.3*this.lastSpeed+.7*i,a=this.options.ctx.lineWidth/(.3*n+1);const o=Math.min(this.lastWidth+.5,Math.max(this.lastWidth-.5,a));this.ctx.lineWidth=o,this.ctx.setLineCap("round"),this.lastWidth=a,this.lastSpeed=n;const c=(s.x+this.newPoint.x)/2,h=(s.y+this.newPoint.y)/2;this.ctx.quadraticCurveTo(c,h,this.newPoint.x,this.newPoint.y),this.points.push(this.newPoint)}touchend(){this.points=[]}rotateCanvas(){return console.log("saveClick"),new Promise(((t,e)=>{s({canvasId:"canvas_container",success:e=>{let{tempFilePath:n}=e;i({src:n,success:e=>{this.ctx.save();let i=this.options.windowWidth/e.height,n=this.options.windowWidth,a=i*e.width;this.ctx.translate(0,a),this.ctx.rotate(-90*Math.PI/180),this.ctx.drawImage(e.path,0,0,a,n),this.ctx.draw(!1,(()=>{console.log("重新绘制成功！"),this.ctx.restore(),s({canvasId:"canvas_container",width:n,height:a,success:e=>{t(e.tempFilePath)},fail(t){console.log("画布转文件error:",t)}},this._this)}))}})},fail(t){console.log("处理生成的画布error:",t)}},this._this)}))}initPen(){this.ctx.lineWidth=this.options.ctx.lineWidth,this.ctx.lineCap=this.options.ctx.lineCap,this.ctx.lineJoin=this.options.ctx.lineJoin,this.ctx.setShadow(0,0,.5,"#000000")}async initPage(){let t=n();this.options.windowWidth=t.windowWidth,this.options.windowHeight=t.windowHeight}async initCanvas(){this.options.canvas_id?(this.ctx=await this.createCanvasInstance(),this.validatenull(this.options.data.url)?(console.log("展示提示消息"),this.resetConfig()):(console.log("绘制图像到画布"),this.initImageToCanvas())):console.log("请配置 canvas_id")}createCanvasInstance(){return new Promise(((t,e)=>{t(a(this.options.canvas_id,this._this))}))}validatenull(t){if("boolean"==typeof t||"number"==typeof t)return!1;if(t instanceof Array){if(0==t.length)return!0}else{if(!(t instanceof Object))return"null"==t||null==t||"undefined"==t||null==t||""==t;if("{}"===JSON.stringify(t))return!0}return!1}resetConfig(){this.drawCount=0,this.initPlaceholder()}initPlaceholder(){this.ctx.save();let{content:t,fontSize:e,textBaseline:s,textAlign:i,fillStyle:n}=this.options.placeholder;this.ctx.setFontSize(e),this.ctx.setTextBaseline(s),this.ctx.setTextAlign(i),this.ctx.setFillStyle(n),this.ctx.translate(this.options.windowWidth/2,this.options.windowHeight/2),this.ctx.rotate(2*Math.PI/4),this.ctx.fillText(t,0,0),this.ctx.draw(!1,(()=>{this.ctx.restore()}))}async initImageToCanvas(){this.drawCount=1,this.ctx.save();let t=this.options.data.url;i({src:t,success:t=>{this.ctx.translate(this.options.windowWidth,0),this.ctx.rotate(90*Math.PI/180),this.ctx.drawImage(t.path,0,0,this.options.windowHeight,this.options.windowWidth),this.ctx.draw(!1,(()=>{this.ctx.restore()}))},fail(t){console.log("初始化图片到画布上error:",t)}})}base64ToTempFile(t){const e=uni.getFileSystemManager(),s=`temp_${Date.now()}.png`,i=`${uni.env.USER_DATA_PATH}/${s}`,n=t.replace(/^data:\w+\/\w+;base64,/,"");return new Promise(((t,s)=>{e.writeFile({filePath:i,data:o(n),encoding:"binary",success:()=>t(i),fail:()=>t(i)})}))}}const B=P({name:"RnCanvas",computed:{btnConfig(){let t=this.options.btn||{},e=t.saveBtn||{},s=t.resetBtn||{},i=t.cancelBtn||{};return{...this.btnOptions,...t,saveBtn:{...this.btnOptions.saveBtn,...e,style:{...this.btnOptions.saveBtn.style,...e.style||{}}},resetBtn:{...this.btnOptions.resetBtn,...s,style:{...this.btnOptions.resetBtn.style,...s.style||{}}},cancelBtn:{...this.btnOptions.cancelBtn,...i,style:{...this.btnOptions.cancelBtn.style,...i.style||{}}}}},btnList(){return[this.btnConfig.cancelBtn,this.btnConfig.resetBtn,this.btnConfig.saveBtn].sort(((t,e)=>t.order-e.order))}},data:()=>({ctx:null,data:{},query:{},options:{},btnShow:!1,btnOptions:{cancelBtn:{prop:"cancel",order:1,content:"取消",class:"btn_cancel",style:{}},resetBtn:{prop:"reset",order:2,content:"清空",class:"btn_reset",style:{}},saveBtn:{prop:"save",order:3,content:"保存",class:"btn_save",style:{}}}}),watch:{data:{handler(t){console.log("签名数据更新1=>",t),t.url&&c(`rnReturnData${this.query.tempTime}`,t)},deep:!0,immediate:!0}},onLoad(t){this.query=t;this.getOpenerEventChannel().on(`receiveData${this.query.tempTime}`,(async({data:t,options:e})=>{this.data=t,this.options=e;setTimeout((()=>{this.initStyle(),this.$nextTick((()=>{this.btnShow=!0,this.ctx=new T({canvas_id:"canvas_container",data:this.data,...e},this),console.log(this.ctx)}))}),300)}))},beforeUnmount(){this.clearStyle()},methods:{async clearStyle(){try{let t=document.querySelectorAll("head style.custom_h5_style");for(let e=0;e<t.length;e++)document.querySelector("head").removeChild(t[e])}catch{}},initStyle(){let t=document.createElement("style");t.type="text/css",t.setAttribute("class","custom_h5_style"),t.innerHTML="@media screen and (orientation: portrait) {\n\t\t\t\t\t.uni-toast,\n\t\t\t\t\t.uni-modal { \n\t\t\t\t\t\ttransform: translate(-50%, -50%) rotate(90deg) !important;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\t.uni-modal_dialog__container.uni-modal_dialog__show {\n\t\t\t\t\ttransform: rotate(90deg) scale(1) !important;\n\t\t\t\t}\n\t\t\t\t",document.querySelector("head").append(t)},clickHandler(t){this[t+"Click"]()},async saveClick(){if(!this.ctx.drawCount)return void h({title:"请进行签名"});let t=await this.ctx.rotateCanvas();this.data.url=t,l(-1)},resetClick(){this.ctx.resetConfig()},cancelClick(){l(-1)},touchstart(t){this.ctx.touchstart(t)},touchmove(t){this.ctx.touchmove(t)},touchend(){}},onReady(){}},[["render",function(t,e,s,i,n,a){const o=v,c=g,h=u;return p(),r(h,{class:"container"},{default:d((()=>[x(o,{class:"canvas_container","canvas-id":"canvas_container",id:"canvas_container","disable-scroll":!0,onTouchstart:a.touchstart,onTouchmove:a.touchmove,onTouchend:a.touchend},null,8,["onTouchstart","onTouchmove","onTouchend"]),x(c,{class:"control_wrap"},{default:d((()=>[(p(!0),w(m,null,y(a.btnList,(t=>(p(),r(c,{key:t.prop,class:f(["btn",t.class]),style:_(t.style),onClick:e=>a.clickHandler(t.prop)},{default:d((()=>[x(c,{class:"text"},{default:d((()=>[b(C(t.content),1)])),_:2},1024)])),_:2},1032,["class","style","onClick"])))),128))])),_:1})])),_:1})}],["__scopeId","data-v-8e3f5e17"]]);export{B as default};
