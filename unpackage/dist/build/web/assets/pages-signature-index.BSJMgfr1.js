import{z as t,$ as e,u as a,o as s,d as n,w as i,e as o,q as r,P as l,n as c,h as d,i as u,s as p,a8 as g,a9 as h,V as m,aa as f,a5 as b,ab as _,c as y,H as S,f as w}from"./index-vclNGZkt.js";import{_ as D}from"./_plugin-vue_export-helper.BCo6x5W8.js";import{r as v}from"./uni-app.es.C4xkBdw-.js";const C=D({name:"RnSignature",props:{options:{type:Object,default:()=>({})},data:{type:Object,default:()=>({url:""})}},computed:{clearClassName(){return this.optionsAll.clear.customClass},optionsAll(){return{...this.options,clear:{...this.config.clear,...this.options.clear||{}},placeholder:{...this.config.placeholder,...this.options.placeholder||{}},style:{...this.config.style,...this.options.style||{}}}}},data:()=>({config:{clear:{show:!0},style:{width:"100%",height:"300rpx",background:"#fff",border:"1px soild",borderRadius:"20rpx"},placeholder:{content:"请点击设置签名"}}}),created(){},mounted(){},methods:{clearClick(){this.data.url=""},btnClick(){this.data.tempTime&&t(`rnReturnData${this.data.tempTime}`),this.data.tempTime=Date.now(),e(`rnReturnData${this.data.tempTime}`,(t=>{for(let e in t)this.data[e]=t[e]})),a({url:`/uni_modules/rn-signature/pages/rn-canvas?tempTime=${this.data.tempTime}`,success:t=>{t.eventChannel.emit(`receiveData${this.data.tempTime}`,{data:this.data,options:this.optionsAll})},fail:t=>{console.log("跳转页面：",t,this.data,"fail")}})}}},[["render",function(t,e,a,p,g,h){const m=d,f=u;return s(),n(f,{class:"rn_signature",style:c([[h.optionsAll.style],{border:"1px soild red"}])},{default:i((()=>[o(f,{class:"sign_container",onClick:h.btnClick},{default:i((()=>[a.data.url?l("",!0):(s(),r("span",{key:0},"请点击设置签名")),a.data.url?(s(),n(m,{key:1,class:"signature_img",src:a.data.url,alt:""},null,8,["src"])):l("",!0)])),_:1},8,["onClick"])])),_:1},8,["style"])}],["__scopeId","data-v-98c26848"]]);const k=D({components:{RnSignature:C},data:()=>({signatureOptions:{placeholder:{content:"请在此手写签名",fontSize:32,textBaseline:"middle",textAlign:"center",fillStyle:"#999999"},clear:{show:!0,slot:!1,customClass:"btn_clear_wrap"},style:{width:"100%",height:"450rpx",borderRadius:"10rpx",border:"2rpx dashed #cccccc"},ctx:{lineWidth:3,lineCap:"round",lineJoin:"round"},btn:{cancelBtn:{content:"取消",order:1,style:{backgroundColor:"#007aff",color:"#fff"}},resetBtn:{content:"重签",order:2,style:{backgroundColor:"#ff9900",color:"#fff"}},saveBtn:{content:"保存",order:3,style:{backgroundColor:"#19be6b",color:"#fff"}}}},signatureData:{url:"",tempTime:Date.now()},isSaving:!1}),onLoad(t){t.signatureUrl&&(this.signatureData.url=decodeURIComponent(t.signatureUrl))},methods:{handleSignatureUpdate(t){console.log("签名数据更新:",t),this.signatureData={...this.signatureData,...t}},saveSignature(){this.signatureData.url?this.isSaving||(this.isSaving=!0,this.uploadSignatureToServer()):p({title:"请先进行签名",icon:"none"})},async uploadSignatureToServer(){console.log("uploadSignatureToServer",this.signatureData);try{g({title:"保存中..."}),console.log("tempFilePath11111");const t=await this.base64ToTempFile(this.signatureData.url);console.log("tempFilePath22222",t);const e=await this.uploadFile(t);if(console.log("uploadResult",e),h(),!e.success)throw new Error(e.message||"上传失败");p({title:"签名保存成功",icon:"success"}),setTimeout((()=>{m({delta:1})}),1500)}catch(t){h(),p({title:t.message||"保存失败",icon:"none"}),console.error("保存签名失败:",t)}finally{this.isSaving=!1}},uploadFile:t=>new Promise(((e,a)=>{f({url:"YOUR_SERVER_API_URL",filePath:t,name:"signature",formData:{userId:"current_user_id",type:"signature"},success:t=>{try{const a=JSON.parse(t.data);e({success:!0,data:a})}catch(s){a(new Error("服务器响应格式错误"))}},fail:t=>{a(new Error("网络请求失败"))}})})),base64ToTempFile:t=>new Promise(((e,a)=>{const s=t.replace(/^data:image\/\w+;base64,/,""),n=b(s),i=uni.getFileSystemManager(),o=`signature_${Date.now()}.png`,r=`${uni.env.USER_DATA_PATH}/${o}`;i.writeFile({filePath:r,data:n,encoding:"binary",success:()=>e(r),fail:t=>a(t)})})),downloadSignature(){if(!this.signatureData.url)return void p({title:"没有可下载的签名",icon:"none"});const t=document.createElement("a");t.href=this.signatureData.url,t.download=`signature_${Date.now()}.png`,document.body.appendChild(t),t.click(),document.body.removeChild(t)},clearSignature(){_({title:"确认清除",content:"确定要清除当前签名吗？",success:t=>{t.confirm&&(this.signatureData.url="",p({title:"已清除",icon:"success"}))}})},goBack(){m({delta:1})}}},[["render",function(t,e,a,r,l,c){const d=v(y("rn-signature"),C),p=u;return s(),n(p,{class:"signature-container"},{default:i((()=>[o(d,{options:l.signatureOptions,data:l.signatureData,"onUpdate:data":c.handleSignatureUpdate},null,8,["options","data","onUpdate:data"]),o(p,{class:"action-buttons"},{default:i((()=>[o(p,{onClick:c.saveSignature,class:S(["save-btn",{disabled:!l.signatureData.url}])},{default:i((()=>[w(" 保存签名 ")])),_:1},8,["onClick","class"]),o(p,{onClick:c.goBack,class:"back-btn"},{default:i((()=>[w(" 返回 ")])),_:1},8,["onClick"])])),_:1})])),_:1})}],["__scopeId","data-v-fe01eba9"]]);export{k as default};
