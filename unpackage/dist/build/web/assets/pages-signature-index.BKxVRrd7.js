import{G as e,$ as t,C as a,o as s,c as n,w as o,b as i,q as r,Q as l,n as c,j as d,i as u,s as p,a9 as g,aa as h,V as m,ab as f,a6 as b,ac as _,a as y,v as S,d as w}from"./index-DszEigh-.js";import{_ as v}from"./_plugin-vue_export-helper.BCo6x5W8.js";import{r as C}from"./uni-app.es.yxr7YjqI.js";const D=v({name:"RnSignature",props:{options:{type:Object,default:()=>({})},data:{type:Object,default:()=>({url:""})}},computed:{clearClassName(){return this.optionsAll.clear.customClass},optionsAll(){return{...this.options,clear:{...this.config.clear,...this.options.clear||{}},placeholder:{...this.config.placeholder,...this.options.placeholder||{}},style:{...this.config.style,...this.options.style||{}}}}},data:()=>({config:{clear:{show:!0},style:{width:"100%",height:"300rpx",background:"#fff",border:"1px soild",borderRadius:"20rpx"},placeholder:{content:"请点击设置签名"}}}),created(){},mounted(){},methods:{clearClick(){this.data.url=""},btnClick(){this.data.tempTime&&e(`rnReturnData${this.data.tempTime}`),this.data.tempTime=Date.now(),t(`rnReturnData${this.data.tempTime}`,(e=>{console.log("签名数据更新2=>",e);for(let t in e)this.data[t]=e[t]})),a({url:`/uni_modules/rn-signature/pages/rn-canvas?tempTime=${this.data.tempTime}`,success:e=>{e.eventChannel.emit(`receiveData${this.data.tempTime}`,{data:this.data,options:this.optionsAll})},fail:e=>{console.log("跳转页面：",e,this.data,"fail")}})}}},[["render",function(e,t,a,p,g,h){const m=d,f=u;return s(),n(f,{class:"rn_signature",style:c([[h.optionsAll.style],{border:"1px soild red"}])},{default:o((()=>[i(f,{class:"sign_container",onClick:h.btnClick},{default:o((()=>[a.data.url?l("",!0):(s(),r("span",{key:0,class:"signature-placeholder"},"请点击设置签名")),a.data.url?(s(),n(m,{key:1,class:"signature_img",src:a.data.url,alt:""},null,8,["src"])):l("",!0)])),_:1},8,["onClick"])])),_:1},8,["style"])}],["__scopeId","data-v-357e431e"]]);let k=null;const T=v({data:()=>({signatureOptions:{placeholder:{content:"请在此手写签名",fontSize:32,textBaseline:"middle",textAlign:"center",fillStyle:"#999999"},clear:{show:!0,slot:!1,customClass:"btn_clear_wrap"},style:{width:"100%",height:"450rpx",borderRadius:"10rpx",border:"2rpx dashed #cccccc"},ctx:{lineWidth:3,lineCap:"round",lineJoin:"round"},btn:{cancelBtn:{content:"取消",order:1,style:{backgroundColor:"#007aff",color:"#fff"}},resetBtn:{content:"重签",order:2,style:{backgroundColor:"#ff9900",color:"#fff"}},saveBtn:{content:"保存",order:3,style:{backgroundColor:"#19be6b",color:"#fff"}}}},signatureData:{url:"",tempTime:Date.now()},isSaving:!1}),onLoad(e){e.signatureUrl&&(console.log("如果从其他页面传递了签名数据，则加载=>",e.signatureUrl),this.signatureData.url=decodeURIComponent(e.signatureUrl))},onUnmounted(){k&&(clearTimeout(k),k=null)},methods:{handleSignatureUpdate(e){console.log("签名数据更新:",e),this.signatureData={...this.signatureData,...e}},saveSignature(){this.signatureData.url?this.isSaving||(this.isSaving=!0,this.uploadSignatureToServer()):p({title:"请先进行签名",icon:"none"})},async uploadSignatureToServer(){console.log("uploadSignatureToServer",this.signatureData);try{g({title:"保存中..."}),console.log("tempFilePath11111");const e=await this.base64ToTempFile(this.signatureData.url);console.log("tempFilePath22222",e);const t=await this.uploadFile(e);if(console.log("uploadResult",t),h(),!t.success)throw new Error(t.message||"上传失败");p({title:"签名保存成功",icon:"success"}),k=setTimeout((()=>{m({delta:1})}),1500)}catch(e){h(),p({title:e.message||"保存失败",icon:"none"}),console.error("保存签名失败:",e)}finally{this.isSaving=!1}},uploadFile:e=>new Promise(((t,a)=>{f({url:"YOUR_SERVER_API_URL",filePath:e,name:"signature",formData:{userId:"current_user_id",type:"signature"},success:e=>{try{const a=JSON.parse(e.data);t({success:!0,data:a})}catch(s){a(new Error("服务器响应格式错误"))}},fail:e=>{a(new Error("网络请求失败"))}})})),base64ToTempFile:e=>new Promise(((t,a)=>{const s=e.replace(/^data:image\/\w+;base64,/,""),n=b(s),o=uni.getFileSystemManager(),i=`signature_${Date.now()}.png`,r=`${uni.env.USER_DATA_PATH}/${i}`;o.writeFile({filePath:r,data:n,encoding:"binary",success:()=>t(r),fail:e=>a(e)})})),downloadSignature(){if(!this.signatureData.url)return void p({title:"没有可下载的签名",icon:"none"});const e=document.createElement("a");e.href=this.signatureData.url,e.download=`signature_${Date.now()}.png`,document.body.appendChild(e),e.click(),document.body.removeChild(e)},clearSignature(){_({title:"确认清除",content:"确定要清除当前签名吗？",success:e=>{e.confirm&&(this.signatureData.url="",p({title:"已清除",icon:"success"}))}})},goBack(){m({delta:1})}}},[["render",function(e,t,a,r,l,c){const d=C(y("rn-signature"),D),p=u;return s(),n(p,{class:"signature-container"},{default:o((()=>[i(d,{options:l.signatureOptions,data:l.signatureData,"onUpdate:data":c.handleSignatureUpdate},null,8,["options","data","onUpdate:data"]),i(p,{class:"action-buttons"},{default:o((()=>[i(p,{onClick:c.saveSignature,class:S(["save-btn",{disabled:!l.signatureData.url}])},{default:o((()=>[w(" 保存签名 ")])),_:1},8,["onClick","class"]),i(p,{onClick:c.goBack,class:"back-btn"},{default:o((()=>[w(" 返回 ")])),_:1},8,["onClick"])])),_:1})])),_:1})}],["__scopeId","data-v-d4514ade"]]);export{T as default};
